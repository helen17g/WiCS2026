rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Helpers ----------
    function signedIn() {
      return request.auth != null;
    }

    // ----- Events (existing helpers) -----
    function isEventOrganizer(eventId) {
      return signedIn()
        && get(/databases/$(database)/documents/events/$(eventId)/members/$(request.auth.uid)).data.role == "organizer";
    }

    function isReportOwner(eventId, reportId) {
      return signedIn()
        && get(/databases/$(database)/documents/events/$(eventId)/reports/$(reportId)).data.createdByUid == request.auth.uid;
    }

    // ----- Groups (NEW helpers) -----
    function isGroupMember(groupId) {
      return signedIn()
        && exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid));
    }

    function isGroupOrganizer(groupId) {
      return signedIn()
        && get(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid)).data.role == "organizer";
    }

    // =========================================================
    // EVENTS
    // =========================================================
    match /events/{eventId} {

      // (Optional) If your frontend needs to read event metadata:
      // allow get, list: if signedIn();
      // (Optional) If your frontend writes events directly (usually NO):
      // allow create: if signedIn();
      // allow update, delete: if isEventOrganizer(eventId);

      match /reports/{reportId} {

        // Organizers or report owner can read the report
        allow read: if isEventOrganizer(eventId) || isReportOwner(eventId, reportId);

        match /messages/{messageId} {
          // allow listing/reading messages for organizers or report owner
          allow read, list: if isEventOrganizer(eventId) || isReportOwner(eventId, reportId);

          // allow creating messages for organizers or report owner
          allow create: if isEventOrganizer(eventId) || isReportOwner(eventId, reportId);

          // no edits/deletes
          allow update, delete: if false;
        }

        match /actions/{actionId} {
          allow read, list: if isEventOrganizer(eventId);
          allow create: if isEventOrganizer(eventId);
          allow update, delete: if false;
        }
      }

      // (Optional) If your frontend needs to read event members for UI:
      // match /members/{uid} {
      //   allow read, list: if signedIn();
      //   allow write: if false; // typically written by Cloud Functions
      // }
    }

    // =========================================================
    // GROUPS (PINS LIVE HERE)
    //
    // Pins are stored at:
    // groups/{groupId}/members/{uid}.location  (lat,lng,label)
    // groups/{groupId}/members/{uid}.shareLocation (boolean)
    // =========================================================
    match /groups/{groupId} {

      // Let group members read the group document (name, joinCode if you store it here, etc.)
      allow get, list: if isGroupMember(groupId);

      // For demo: allow any signed-in user to create a group doc.
      // If you only create groups via Cloud Functions, you can change this to: if false;
      allow create: if signedIn();

      // Only organizers can update/delete group doc
      allow update, delete: if isGroupOrganizer(groupId);

      match /members/{uid} {
        // Members can read the member list (needed to render pins)
        allow read, list: if isGroupMember(groupId);

        // If you ONLY join via Cloud Functions, set create to false.
        // If you want client-side join (not recommended), leave this true.
        allow create: if false;

        // Users can update ONLY their own member doc
        // (toggle shareLocation + update location pin)
        allow update: if signedIn() && request.auth.uid == uid;

        // For demo: no deletes
        allow delete: if false;
      }
    }

    // =========================================================
    // GROUP CODES (LOCKED DOWN)
    //
    // Join-by-code should happen via Cloud Function so users
    // can't enumerate codes or read them directly.
    // =========================================================
    match /groupCodes/{code} {
      allow read, write: if false;
    }

    // (Optional) If you used joinCodes instead of groupCodes:
    // match /joinCodes/{code} {
    //   allow read, write: if false;
    // }

  }
}
